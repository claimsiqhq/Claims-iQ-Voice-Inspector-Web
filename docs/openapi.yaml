openapi: 3.0.3
info:
  title: Claims IQ Voice Inspector API
  description: |
    RESTful API for the Claims IQ Voice Inspector â€” a voice-driven property
    inspection platform for insurance adjusters. Supports claim management,
    document extraction, real-time voice inspections via OpenAI Realtime API,
    estimate generation with Xactimate-compatible pricing, and ESX/PDF export.
  version: 1.0.0
  contact:
    name: Claims IQ Engineering
  license:
    name: Proprietary

servers:
  - url: http://localhost:5000
    description: Local development
  - url: https://{replit-slug}.replit.app
    description: Replit deployment
    variables:
      replit-slug:
        default: Claims-iQ-Voice-Inspector

tags:
  - name: Claims
  - name: Documents
  - name: Inspection
  - name: Rooms
  - name: Damages
  - name: LineItems
  - name: Realtime
  - name: Export
  - name: Pricing
  - name: Auth
  - name: Admin
  - name: Health

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: Supabase JWT token
  schemas:
    Error:
      type: object
      properties:
        message: { type: string }
      required: [message]
    Claim:
      type: object
      properties:
        id: { type: integer }
        claimNumber: { type: string }
        insuredName: { type: string }
        propertyAddress: { type: string }
        city: { type: string }
        state: { type: string }
        zip: { type: string }
        dateOfLoss: { type: string }
        perilType: { type: string }
        status: { type: string }
        assignedTo: { type: string, nullable: true }
    CreateClaimRequest:
      type: object
      required: [claimNumber]
      properties:
        claimNumber: { type: string, minLength: 1 }
        insuredName: { type: string }
        propertyAddress: { type: string }
        city: { type: string }
        state: { type: string }
        zip: { type: string }
        dateOfLoss: { type: string }
        perilType: { type: string }
        status: { type: string }
    HealthResponse:
      type: object
      properties:
        status: { type: string }
        timestamp: { type: string, format: date-time }
        uptime: { type: number }
    ReadinessResponse:
      type: object
      properties:
        status: { type: string, enum: [ready, not_ready] }
        timestamp: { type: string, format: date-time }
        checks: { type: object }

security:
  - bearerAuth: []

paths:
  /health:
    get:
      tags: [Health]
      summary: Liveness check
      security: []
      responses:
        "200":
          description: Service is running
          content:
            application/json:
              schema: { $ref: "#/components/schemas/HealthResponse" }
  /readiness:
    get:
      tags: [Health]
      summary: Readiness check (DB, storage, OpenAI)
      security: []
      responses:
        "200": { description: All subsystems ready }
        "503": { description: One or more subsystems not ready }
  /api/claims:
    get:
      tags: [Claims]
      summary: List all claims
      responses:
        "200":
          description: Array of claims
          content:
            application/json:
              schema:
                type: array
                items: { $ref: "#/components/schemas/Claim" }
    post:
      tags: [Claims]
      summary: Create a new claim
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: "#/components/schemas/CreateClaimRequest" }
      responses:
        "201": { description: Claim created }
        "400": { description: Validation error }
  /api/claims/{id}:
    get:
      tags: [Claims]
      summary: Get claim with documents, extractions, briefing
      parameters:
        - name: id
          in: path
          required: true
          schema: { type: integer }
      responses:
        "200": { description: Claim with related data }
        "404": { description: Claim not found }
    patch:
      tags: [Claims]
      summary: Update claim
      parameters:
        - name: id
          in: path
          required: true
          schema: { type: integer }
      responses:
        "200": { description: Updated claim }
    delete:
      tags: [Claims]
      summary: Delete claim
      parameters:
        - name: id
          in: path
          required: true
          schema: { type: integer }
      responses:
        "200": { description: Claim deleted }
  /api/claims/{id}/documents/upload:
    post:
      tags: [Documents]
      summary: Upload PDF document
      parameters:
        - name: id
          in: path
          required: true
          schema: { type: integer }
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [fileName, fileBase64, documentType]
              properties:
                fileName: { type: string }
                fileBase64: { type: string }
                documentType: { type: string, enum: [fnol, policy, endorsements] }
      responses:
        "200": { description: Document uploaded }
  /api/claims/{id}/inspection/start:
    post:
      tags: [Inspection]
      summary: Start or resume inspection session
      parameters:
        - name: id
          in: path
          required: true
          schema: { type: integer }
      responses:
        "200": { description: Session (new or existing) }
  /api/inspection/{sessionId}:
    get:
      tags: [Inspection]
      summary: Get session with rooms, line items, photos, damages
      parameters:
        - name: sessionId
          in: path
          required: true
          schema: { type: integer }
      responses:
        "200": { description: Full session data }
    patch:
      tags: [Inspection]
      summary: Update session phase, room, structure, status
      parameters:
        - name: sessionId
          in: path
          required: true
          schema: { type: integer }
      responses:
        "200": { description: Updated session }
  /api/inspection/{sessionId}/complete:
    post:
      tags: [Inspection]
      summary: Complete inspection session
      parameters:
        - name: sessionId
          in: path
          required: true
          schema: { type: integer }
      responses:
        "200": { description: Session completed }
  /api/inspection/{sessionId}/rooms:
    post:
      tags: [Rooms]
      summary: Create room
    get:
      tags: [Rooms]
      summary: List rooms in session
  /api/inspection/{sessionId}/damages:
    post:
      tags: [Damages]
      summary: Record damage observation
    get:
      tags: [Damages]
      summary: Get damages for session
  /api/inspection/{sessionId}/line-items:
    post:
      tags: [LineItems]
      summary: Add estimate line item
    get:
      tags: [LineItems]
      summary: Get line items in session
  /api/inspection/{sessionId}/estimate-summary:
    get:
      tags: [LineItems]
      summary: Get estimate totals (RCV, depreciation, ACV)
  /api/realtime/session:
    post:
      tags: [Realtime]
      summary: Create OpenAI Realtime API session
      requestBody:
        content:
          application/json:
            schema:
              type: object
              required: [claimId, sessionId]
              properties:
                claimId: { type: integer }
                sessionId: { type: integer }
      responses:
        "200": { description: Ephemeral client secret for WebRTC }
  /api/inspection/{sessionId}/export/esx:
    post:
      tags: [Export]
      summary: Generate Xactimate ESX file
      parameters:
        - name: sessionId
          in: path
          required: true
          schema: { type: integer }
      responses:
        "200":
          description: ESX ZIP file
          content:
            application/zip:
              schema: { type: string, format: binary }
  /api/inspection/{sessionId}/export/pdf:
    post:
      tags: [Export]
      summary: Generate inspection report PDF
      parameters:
        - name: sessionId
          in: path
          required: true
          schema: { type: integer }
      responses:
        "200":
          description: PDF report
          content:
            application/pdf:
              schema: { type: string, format: binary }
  /api/pricing/catalog:
    get:
      tags: [Pricing]
      summary: Get full pricing catalog
  /api/pricing/seed:
    post:
      tags: [Pricing]
      summary: Seed pricing catalog (admin only)
  /api/auth/sync:
    post:
      tags: [Auth]
      summary: Sync Supabase user to local database
  /api/auth/me:
    get:
      tags: [Auth]
      summary: Get current user profile
  /api/admin/dashboard:
    get:
      tags: [Admin]
      summary: Get dashboard statistics
  /api/admin/active-sessions:
    get:
      tags: [Admin]
      summary: List active inspection sessions
